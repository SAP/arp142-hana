#!/bin/bash
umask 0027

#------------------------------------------------------------------
# Library - x86_64 configuration
#------------------------------------------------------------------
# (C) Copyright SAP 2018-2019
# Author: DBS - CoE EMEA HANA Platform & Technical Infrastructure
#
# Script name: "lib_platf_x86_64"
#
#------------------------------------------------------------------

# return if library is already loaded
[[ -n "${LIB_PLATF_x86_64_RELEASE:-}" ]] && return 0

LIB_PLATF_x86_64_RELEASE='1811.0-dev'

##########################################################
# Global functions - to be used in other scripts
##########################################################

##########################################################
# Non-global functions - not to be used in other scripts
##########################################################
function __get_platform_x86_64_vendor_details {

    logTrace "<${BASH_SOURCE[0]}:${FUNCNAME[*]}>"

    if [[ -e '/sys/devices/virtual/dmi/id' ]]; then

        shopt -s extglob    #enable extended pattern matching

        # Vendor - IBM, Lenovo, "Microsoft Corporation" , "Xen" , "Google" , "Cisco Systems Inc"
        if [[ -z ${LIB_PLATF_VENDOR:-} ]]; then
            LIB_PLATF_VENDOR="$(</sys/devices/virtual/dmi/id/sys_vendor)"
            LIB_PLATF_VENDOR=${LIB_PLATF_VENDOR//+([[:space:]])/ }

            if [[ "${LIB_PLATF_VENDOR}" == 'Xen' ]]; then
                #special Amazon EC2 handling

                local __bios_version
                __bios_version="$(</sys/devices/virtual/dmi/id/bios_version)"

                LIB_FUNC_STRINGCONTAIN "${__bios_version}" 'amazon' && LIB_PLATF_VENDOR='Amazon EC2'

            elif [[ "${LIB_PLATF_VENDOR}" == 'Microsoft Corporation' ]]; then

                LIB_PLATF_VENDOR='Microsoft Azure'
            fi

            readonly LIB_PLATF_VENDOR
        fi

        # Platform - "x3950 X6 -[6241ZB5]-", "ProLiant DL785 G6",
        #          - "VMware Virtual Platform", "RHEV Hypervisor" , "Virtual Machine" , "Google Compute Engine" , "HVM domU"
        if [[ -z ${LIB_PLATF_NAME:-} ]]; then
            LIB_PLATF_NAME="$(</sys/devices/virtual/dmi/id/product_name)"
            LIB_PLATF_NAME=${LIB_PLATF_NAME//+([[:space:]])/ }
            readonly LIB_PLATF_NAME
        fi

        shopt -u extglob    #disable extended pattern matching

    fi

}

function __get_platform_x86_64_cpu_details {

    logTrace "<${BASH_SOURCE[0]}:${FUNCNAME[*]}>"

    # get System details
    local -a platform

    local -r IFS=$'\n';
    platform=( "$(lscpu)" )

    local line
    for line in ${platform[*]:-}; do

        logTrace "<${FUNCNAME[0]}> # ${line}>"

        case ${line} in

        'Architecture:'*)
                            if [[ -z ${LIB_PLATF_ARCHITECTURE:-} ]]; then
                                LIB_PLATF_ARCHITECTURE=$(LIB_FUNC_TRIM_LEFT "${line/Architecture:}")
                                readonly LIB_PLATF_ARCHITECTURE
                            fi
        ;;
        'Byte Order:'*)
                            LIB_PLATF_BYTEORDER=$(LIB_FUNC_TRIM_LEFT "${line/Byte Order:}")
                            readonly LIB_PLATF_BYTEORDER
                            #break
        ;;

        'Thread(s) per core:'*)
                            if [[ -z ${LIB_PLATF_CPU_THREADSPERCORE:-} ]]; then
                                LIB_PLATF_CPU_THREADSPERCORE=$(LIB_FUNC_TRIM_LEFT "${line/Thread(s) per core:}")
                                readonly LIB_PLATF_CPU_THREADSPERCORE
                            fi
        ;;

        'Core(s) per socket:'*)
                            if [[ -z ${LIB_PLATF_CPU_CORESPERSOCKET:-} ]]; then
                                LIB_PLATF_CPU_CORESPERSOCKET=$(LIB_FUNC_TRIM_LEFT "${line/Core(s) per socket:}")
                                readonly LIB_PLATF_CPU_CORESPERSOCKET
                            fi
        ;;

        'Socket(s):'*)
                            if [[ -z ${LIB_PLATF_CPU_SOCKETS:-} ]]; then
                                LIB_PLATF_CPU_SOCKETS=$(LIB_FUNC_TRIM_LEFT "${line/Socket(s):}")
                                readonly LIB_PLATF_CPU_SOCKETS
                            fi
        ;;

        'NUMA node(s):'*)
                            if [[ -z ${LIB_PLATF_CPU_NUMANODES:-} ]]; then
                                LIB_PLATF_CPU_NUMANODES=$(LIB_FUNC_TRIM_LEFT "${line/NUMA node(s):}")
                                readonly LIB_PLATF_CPU_NUMANODES
                            fi
        ;;

        'Vendor ID:'*)		#GenuineIntel; AuthenticAMD
                            if [[ -z ${LIB_PLATF_CPU_VENDOR:-} ]]; then
                                LIB_PLATF_CPU_VENDOR=$(LIB_FUNC_TRIM_LEFT "${line/Vendor ID:}")
                                readonly LIB_PLATF_CPU_VENDOR
                            fi
        ;;

        'Model:'*)			#on Intel <Model: 63>
                            LIB_PLATF_CPU_MODELID=$(LIB_FUNC_TRIM_LEFT "${line/Model:}")
                            readonly LIB_PLATF_CPU_MODELID
        ;;

        'Model name:'*)		#on x64 only
                            #<Intel(R) Xeon(R) CPU E7-8880 v3 @ 2.30GHz>; AMD Opteron 23xx (Gen 3 Class Opteron)
                            if [[ -z ${LIB_PLATF_CPU:-} ]]; then
                                LIB_PLATF_CPU=$(LIB_FUNC_TRIM_LEFT "${line/Model name:}")
                                readonly LIB_PLATF_CPU
                            fi
        ;;

        # Virtualization information provided by lscpu version >=2.19 and only if virtualized
        # x64:  ( VMware - full ) ; ( KVM - full ) = RHEV ; ( Xen - none ) ; ( Xen - full ) = Amazon EC2

        'Hypervisor vendor:'*)
                            if [[ -z ${LIB_PLATF_VIRT_HYPER:-} ]]; then
                                LIB_PLATF_VIRT_HYPER=$(LIB_FUNC_TRIM_LEFT "${line/Hypervisor vendor:}")
                                readonly LIB_PLATF_VIRT_HYPER
                            fi
        ;;

        'Virtualization type:'*)
                            if [[ -z ${LIB_PLATF_VIRT_TYPE:-} ]]; then
                                LIB_PLATF_VIRT_TYPE=$(LIB_FUNC_TRIM_LEFT "${line/Virtualization type:}")
                                readonly LIB_PLATF_VIRT_TYPE
                            fi
                            break
        ;;

        esac

    done

    if [[ -z ${LIB_PLATF_CPU:-} ]]; then

        LIB_PLATF_CPU=$(grep  'model name' /proc/cpuinfo | sort -u)
        LIB_PLATF_CPU=$(LIB_FUNC_TRIM_LEFT "${LIB_PLATF_CPU/model name[[:blank:]]:}")

        readonly LIB_PLATF_CPU
    fi

}


#============================================================
# LIB MAIN - initialization
#============================================================
function _lib_platf_x86_64_main {

    logTrace "<${BASH_SOURCE[0]}:${FUNCNAME[*]}>"

    __get_platform_x86_64_cpu_details
    __get_platform_x86_64_vendor_details

    #readonly <AnyVariable>
}

#Import libraries
#shellcheck source=./saphana-logger
source "$( cd "${BASH_SOURCE[0]%/*}" && pwd )/saphana-logger" ||
                { echo 'unable to load saphana-logger library' >&2; exit 1; }
#shellcheck source=./saphana-helper-funcs
source "$( cd "${BASH_SOURCE[0]%/*}" && pwd )/saphana-helper-funcs" ||
                { echo 'unable to load saphana-helper-funcs library' >&2; exit 1; }
#LIB LOCAL

#GLOBAL
#don't use declare here ... file is sourced within function, which would restrict visibility

#CALL MAIN
_lib_platf_x86_64_main
