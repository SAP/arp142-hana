#!/usr/bin/env bash

function check_8050_hana_revision_infra_issues {

    logTrace "<${BASH_SOURCE[0]}:${FUNCNAME[*]}>"

    local -i _retval=99

    # MODIFICATION SECTION>>
    # SAP Note descriptions lookup table
    declare -rA _sapnote_descriptions=(
        ['2044468']='Partitioning redo log'
        ['2222110']='Problem with timer thread'
        ['3312868']='Script hdbenv.sh takes a long time to complete'
        ['3343278']='Nameserver is Unresponsive due to blocked Asynchronous Requests'
        ['3356185']='Long Critical Phase For Savepoint'
        ['3366673']='landscapeHostConfiguration.py fails with Python runtime (spawn)'
        ['3434285']='Nameserver Unresponsive due to Failing Disk Polling (getDiskInfo)'
        ['3435077']='Nameserver Hangs (ClockMonitor)'
        ['3466826']='Savepoint Slowness With FRO/PMEM'
        ['3499670']='DML Statements Adding LOBs Hanging in Thread_State Resource Load Wait'
        ['3528623']='Slow in table load/reload due to load trace writing'
        ['3555251']='Data Volume Encryption / Decryption is Hanging in TouchOldPagesJob'
        ['3573023']='HANA DB Sessions Remain in Status Running (Cancel Requested)'
        ['3600754']='Slow logreplay performance on HANA 2 SPS08 of redo log created on HANA 2 <= SPS07'
        ['3608008']='CPU Spikes and Blocked Savepoints ... on Exhausted TMPFS (NVM-FRO)'
        ['3610237']='Indexserver Crash on virtualized Intel Ice Lake hosts'
        ['3632493']='Shared Memory Allocation Failure on System Replication Secondary'
        ['3665521']='Unresponsive System due to Memory Reclaim of Huge Alignment Pages'
        ['3669696']='Unresponsive System due to late Memory Reclaim cause of gc_unused_memory_threshold-*'
        ['3678935']='System CPU Consumption is Very High and the Performance is Poor due to sslmaxprotocolversion=tls13'
        ['3680406']='Optimizing Memory Allocation for SAP HANA Services by Adjusting min_segment_size'
        ['3687338']='Huge Block Allocator (HBA) Lock Contention During Asynchronous Garbage Collection (GC)'
        ['3689045']='Configured File I/O Throughput Limit Not Enforced'
        ['3693972']='Unexpected Nameserver Stop and Restart After Takeover due to Topology Timestamp Difference'
        ['3716078']='Long Running Savepoints To Flush Many Small Pages To Disk'
        ['issue348679']='landscapeHostConfiguration.py reports "unkown" status after "partial" and before "starting"'
    )

    # array             'SPSP'  'lower bound'    'upper bound'  'SAP Note'
    local -a _hana_all=(\
                        '5'     '2.00.056.00'    '2.00.059.06'  '3312868'   \

                        '5'     '2.00.050.00'    '2.00.059.09'  '3356185'   \
                        '7'     '2.00.070.00'    '2.00.071.00'  '3356185'   \

                        '5'     '2.00.050.00'    '2.00.059.12'  '3466826'   \
                        '7'     '2.00.070.00'    '2.00.077.00'  '3466826'   \

                        '5'     '2.00.050.00'    '2.00.059.14'  '3499670'   \
                        '7'     '2.00.070.00'    '2.00.079.00'  '3499670'   \

                        '5'     '2.00.050.00'    '2.00.059.09'  '2222110'   \
                        '7'     '2.00.070.00'    '2.00.071.00'  '2222110'   \

                        '7'     '2.00.070.00'    '2.00.076.00'  '3435077'   \

                        '5'     '2.00.050.00'    '2.00.059.14'  '3434285'   \
                        '7'     '2.00.070.00'    '2.00.079.01'  '3434285'   \

                        '5'     '2.00.050.00'    '2.00.059.12'  '2044468'   \
                        '7'     '2.00.070.00'    '2.00.076.00'  '2044468'   \

                        '5'     '2.00.050.00'    '2.00.059.99'  '3528623'   \
                        '7'     '2.00.070.00'    '2.00.079.01'  '3528623'   \

                        '5'     '2.00.050.00'    '2.00.059.09'  '3343278'   \
                        '7'     '2.00.070.00'    '2.00.072.00'  '3343278'   \

                        '5'     '2.00.050.00'    '2.00.059.10'  '3366673'   \
                        '7'     '2.00.070.00'    '2.00.073.00'  '3366673'   \

                        '7'     '2.00.070.00'    '2.00.079.02'  '3555251'   \

                        '8'     '2.00.080.00'    '2.00.084.00'  '3600754'   \

                        '7'     '2.00.070.00'    '2.00.079.04'  '3608008'   \
                        '8'     '2.00.080.00'    '2.00.085.00'  '3608008'   \

                        '7'     '2.00.070.00'    '2.00.079.08'  '3632493'   \
                        '8'     '2.00.080.00'    '2.00.089.00'  '3632493'   \

                        '5'     '2.00.050.00'    '2.00.059.99'  '3665521'   \
                        '7'     '2.00.070.00'    '2.00.079.99'  '3665521'   \
                        '8'     '2.00.080.00'    '2.00.089.99'  '3665521'   \

                        '5'     '2.00.050.00'    '2.00.059.99'  '3669696'   \
                        '7'     '2.00.070.00'    '2.00.079.99'  '3669696'   \
                        '8'     '2.00.080.00'    '2.00.089.99'  '3669696'   \

                        '5'     '2.00.050.00'    '2.00.059.99'  '3680406'   \
                        '7'     '2.00.070.00'    '2.00.079.99'  '3680406'   \
                        '8'     '2.00.080.00'    '2.00.089.99'  '3680406'   \

                        '7'     '2.00.070.00'    '2.00.079.03'  '3687338'   \
                        '8'     '2.00.080.00'    '2.00.084.00'  '3687338'   \

                        '5'     '2.00.050.00'    '2.00.059.99'  '3678935'   \
                        '7'     '2.00.070.00'    '2.00.079.07'  '3678935'   \
                        '8'     '2.00.080.00'    '2.00.088.00'  '3678935'   \

                        '7'     '2.00.070.00'    '2.00.079.07'  '3689045'   \
                        '8'     '2.00.080.00'    '2.00.088.00'  '3689045'   \

                        '5'     '2.00.059.18'    '2.00.059.99'  '3693972'   \
                        '7'     '2.00.079.05'    '2.00.079.99'  '3693972'   \
                        '8'     '2.00.086.00'    '2.00.089.99'  '3693972'   \

                        '7'     '2.00.070.00'    '2.00.079.05'  '3716078'   \
                        '8'     '2.00.080.00'    '2.00.086.00'  '3716078'   \

                        '7'     '2.00.079.03'    '2.00.079.08'  'issue348679'   \
                        '8'     '2.00.083.00'    '2.00.089.00'  'issue348679'   \
                        )

    local -ar _hana_intel=(\
                        '7'     '2.00.070.00'    '2.00.079.05'  '3610237'   \
                        '8'     '2.00.080.00'    '2.00.085.00'  '3610237'   \
                        )

    local -ar _hana_ibmpower=(\
                        '8'     '2.00.080.00'    '2.00.082.00'  '3573023'   \
                        )

    local sapnote=''
    # MODIFICATION SECTION<<

    # PRECONDITIONS
    if [[ ${#HANA_SIDS[@]} -eq 0 ]]; then

        logCheckSkipped 'No SAP HANA instance found. Skipping' "<${FUNCNAME[0]}>"
        _retval=3

    elif LIB_FUNC_IS_INTEL; then

        _hana_all+=("${_hana_intel[@]}")

    elif LIB_FUNC_IS_IBMPOWER; then

        _hana_all+=("${_hana_ibmpower[@]}")

    fi

    # CHECK
    if [[ ${_retval} -eq 99 ]]; then

        local _hana_lower
        local _hana_upper
        local _hana_curr
        local _descr
        local _sid_listed=false

        for sid in "${HANA_SIDS[@]}"; do

            _hana_curr=$(GET_HANA_ARRAY_KV "HANA_${sid}" 'release')
            [[ ${_hana_curr} == 'n/a' ]] && continue
            [[ -z ${_hana_curr:6:1} ]] && continue

            _sid_listed=false

            # i+=4 --> every 4th item
            for ((i=0; i < ${#_hana_all[@]}; i+=4)); do

                logTrace "<${FUNCNAME[0]}> # ${_hana_all[$i]}>"

                [[ "${_hana_all[$i]}" != "${_hana_curr:6:1}" ]] && continue #2.00.067 --> 6

                _hana_lower="${_hana_all[$i + 1]}"
                _hana_upper="${_hana_all[$i + 2]}"

                # returns 0 if equal, 1 if first is higher, 2 if second is higher
                LIB_FUNC_COMPARE_VERSIONS "${_hana_curr}" "${_hana_upper}"
                if [[ $? -ne 1 ]]; then
                    #HANA is NOT higher than high boundary

                    LIB_FUNC_COMPARE_VERSIONS "${_hana_curr}" "${_hana_lower}"

                    if [[ $? -le 1 ]]; then

                        sapnote="${_hana_all[$i + 3]}"
                        _descr="${_sapnote_descriptions[${sapnote}]}"

                        if [[ ${_sid_listed} == false ]]; then

                            logCheckWarning "SAP HANA instance potentially affected by infra-related issue (SID: ${sid}, Release: ${_hana_curr})"
                            _sid_listed=true

                        fi

                        logCheckWarning "- ${_descr} (SAP Note ${sapnote:-})(fixed in > ${_hana_upper:-})"
                        _retval=1

                    fi
                fi

            done

        done

        if [[ ${_retval} -eq 99 ]]; then

            logCheckOk 'No known infra-related issues exist for any SAP HANA instances'
            _retval=0

        else

            logCheckWarning 'Some SAP HANA instances potentially affected by infra-related issues'
            _retval=1

        fi

    fi

    logDebug "<${BASH_SOURCE[0]}:${FUNCNAME[0]}> # RC=${_retval}"
    return ${_retval}

}
